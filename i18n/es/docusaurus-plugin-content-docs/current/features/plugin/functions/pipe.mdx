---
sidebar_position: 1
title: " Funci贸n Pipe"
---

#  Funci贸n Pipe: Crear "Agentes/Modelos" Personalizados
隆Bienvenido a esta gu铆a sobre c贸mo crear **Pipes** en Open WebUI! Piensa en los Pipes como una forma de **a帽adir** un nuevo modelo a Open WebUI. En este documento, desglosaremos qu茅 es un Pipe, c贸mo funciona y c贸mo puedes crear el tuyo propio para a帽adir l贸gica personalizada y procesamiento a tus modelos de Open WebUI. Usaremos met谩foras claras y revisaremos cada detalle para garantizar que tengas una comprensi贸n completa.


## Introducci贸n a los Pipes

Imagina Open WebUI como un **sistema de plomer铆a** donde los datos fluyen a trav茅s de tuber铆as y v谩lvulas. En esta analog铆a:

- **Pipes** son como **plugins** que te permiten introducir nuevos caminos para que los datos fluyan, permiti茅ndote inyectar l贸gica y procesamiento personalizados.
- **V谩lvulas** son las **partes configurables** de tu pipe que controlan c贸mo los datos fluyen a trav茅s de 茅l.

Al crear un Pipe, esencialmente est谩s dise帽ando un modelo personalizado con el comportamiento espec铆fico que deseas, todo dentro del marco de Open WebUI.

---

## Comprendiendo la Estructura de los Pipes

Comencemos con una versi贸n b谩sica y sencilla de un Pipe para entender su estructura:

```python
from pydantic import BaseModel, Field

class Pipe:
    class Valves(BaseModel):
        MODEL_ID: str = Field(default="")

    def __init__(self):
        self.valves = self.Valves()

    def pipe(self, body: dict):
        # Aqu铆 va la l贸gica
        print(self.valves, body)  # Esto imprime las opciones de configuraci贸n y el cuerpo de entrada
        return "隆Hola, mundo!"
```

### La Clase Pipe

- **Definici贸n**: La clase `Pipe` es donde defines tu l贸gica personalizada.
- **Prop贸sito**: Act煤a como el plano para tu plugin, determinando c贸mo se comporta dentro de Open WebUI.

### V谩lvulas: Configurando tu Pipe

- **Definici贸n**: `Valves` es una clase anidada dentro de `Pipe`, que hereda de `BaseModel`.
- **Prop贸sito**: Contiene las opciones de configuraci贸n (par谩metros) que persisten a lo largo del uso de tu Pipe.
- **Ejemplo**: En el c贸digo anterior, `MODEL_ID` es una opci贸n de configuraci贸n con una cadena de texto vac铆a por defecto.

**Met谩fora**: Piensa en las v谩lvulas como las perillas en un sistema de tuber铆a real que controlan el flujo del agua. En tu Pipe, las v谩lvulas permiten a los usuarios ajustar configuraciones que influyen en c贸mo fluyen y se procesan los datos.

### El M茅todo `__init__`

- **Definici贸n**: El m茅todo constructor de la clase `Pipe`.
- **Prop贸sito**: Inicializa el estado del Pipe y configura los componentes necesarios.
- **Mejor pr谩ctica**: Mantenlo simple; principalmente inicializa `self.valves` aqu铆.

```python
def __init__(self):
    self.valves = self.Valves()
```

### La Funci贸n `pipe`

- **Definici贸n**: La funci贸n principal donde reside tu l贸gica personalizada.
- **Par谩metros**:
  - `body`: Un diccionario que contiene los datos de entrada.
- **Prop贸sito**: Procesa los datos de entrada utilizando tu l贸gica personalizada y devuelve el resultado.

```python
def pipe(self, body: dict):
    # Aqu铆 va la l贸gica
    print(self.valves, body)  # Esto imprime las opciones de configuraci贸n y el cuerpo de entrada
    return "隆Hola, mundo!"
```

**Nota**: Siempre coloca `Valves` en la parte superior de tu clase `Pipe`, seguido de `__init__` y luego la funci贸n `pipe`. Esta estructura asegura claridad y consistencia.

---

## Creaci贸n de M煤ltiples Modelos con Pipes

驴Qu茅 sucede si quieres que tu Pipe cree **m煤ltiples modelos** dentro de Open WebUI? Esto se puede lograr definiendo una funci贸n o variable `pipes` dentro de tu clase `Pipe`. Esta configuraci贸n, que se llama informalmente **manifold**, permite que tu Pipe represente m煤ltiples modelos.

Aqu铆 tienes c贸mo hacerlo:

```python
from pydantic import BaseModel, Field

class Pipe:
    class Valves(BaseModel):
        MODEL_ID: str = Field(default="")

    def __init__(self):
        self.valves = self.Valves()

    def pipes(self):
        return [
            {"id": "model_id_1", "name": "model_1"},
            {"id": "model_id_2", "name": "model_2"},
            {"id": "model_id_3", "name": "model_3"},
        ]

    def pipe(self, body: dict):
        # Aqu铆 va la l贸gica
        print(self.valves, body)  # Imprime las opciones de configuraci贸n y el cuerpo de entrada
        model = body.get("model", "")
        return f"{model}: 隆Hola, mundo!"
```

### Explicaci贸n

- **Funci贸n `pipes`**:
  - Devuelve una lista de diccionarios.
  - Cada diccionario representa un modelo con claves 煤nicas `id` y `name`.
  - Estos modelos aparecer谩n individualmente en el selector de modelos de Open WebUI.

- **Funci贸n `pipe` Actualizada**:
  - Procesa entrada basada en el modelo seleccionado.
  - En este ejemplo, incluye el nombre del modelo en la cadena devuelta.

---

## Ejemplo: Pipe Proxy de OpenAI

Vamos a profundizar en un ejemplo pr谩ctico donde crearemos un Pipe que act煤a como proxy para las solicitudes a la API de OpenAI. Este Pipe recuperar谩 los modelos disponibles de OpenAI y permitir谩 a los usuarios interactuar con ellos a trav茅s de Open WebUI.

```python
from pydantic import BaseModel, Field
import requests

class Pipe:
    class Valves(BaseModel):
        NAME_PREFIX: str = Field(
            default="OPENAI/",
            description="Prefijo que se a帽adir谩 antes de los nombres de los modelos.",
        )
        OPENAI_API_BASE_URL: str = Field(
            default="https://api.openai.com/v1",
            description="URL base para acceder a los endpoints de la API de OpenAI.",
        )
        OPENAI_API_KEY: str = Field(
            default="",
            description="Clave API para autenticar las solicitudes a la API de OpenAI.",
        )

    def __init__(self):
        self.valves = self.Valves()

    def pipes(self):
        if self.valves.OPENAI_API_KEY:
            try:
                headers = {
                    "Authorization": f"Bearer {self.valves.OPENAI_API_KEY}",
                    "Content-Type": "application/json",
                }

                r = requests.get(
                    f"{self.valves.OPENAI_API_BASE_URL}/models", headers=headers
                )
                models = r.json()
                return [
                    {
                        "id": model["id"],
                        "name": f{self.valves.NAME_PREFIX}{model.get("name", model["id"])},
                    }
                    for model in models["data"]
                    if "gpt" in model["id"]
                ]

            except Exception as e:
                return [
                    {
                        "id": "error",
                        "name": "Error al obtener los modelos. Por favor, revise su clave API.",
                    },
                ]
        else:
            return [
                {
                    "id": "error",
                    "name": "Clave API no proporcionada.",
                },
            ]

    def pipe(self, body: dict, __user__: dict):
        print(f"pipe:{__name__}")
        headers = {
            "Authorization": f"Bearer {self.valves.OPENAI_API_KEY}",
            "Content-Type": "application/json",
        }

        # Extraer el id del modelo a partir del nombre del modelo
        model_id = body["model"][body["model"].find(".") + 1 :]

        # Actualizar el id del modelo en el cuerpo
        payload = {**body, "model": model_id}
        try:
            r = requests.post(
                url=f"{self.valves.OPENAI_API_BASE_URL}/chat/completions",
                json=payload,
                headers=headers,
                stream=True,
            )

            r.raise_for_status()

            if body.get("stream", False):
                return r.iter_lines()
            else:
                return r.json()
        except Exception as e:
            return f"Error: {e}"
```

### Desglose Detallado

#### Configuraci贸n de Valves

- **`NAME_PREFIX`**:
  - A帽ade un prefijo a los nombres de los modelos mostrados en Open WebUI.
  - Valor por defecto: `"OPENAI/"`.
- **`OPENAI_API_BASE_URL`**:
  - Especifica la URL base para la API de OpenAI.
  - Valor por defecto: `"https://api.openai.com/v1"`.
- **`OPENAI_API_KEY`**:
  - Su clave API de OpenAI para autenticaci贸n.
  - Valor por defecto: `""` (cadena vac铆a; debe proporcionarse).

#### La Funci贸n `pipes`

- **Prop贸sito**: Obtiene los modelos disponibles de OpenAI y los hace accesibles en Open WebUI.

- **Proceso**:
  1. **Comprobar Clave API**: Verifica que se haya proporcionado una clave API.
  2. **Obtener Modelos**: Realiza una solicitud GET a la API de OpenAI para recuperar los modelos disponibles.
  3. **Filtrar Modelos**: Devuelve los modelos que contienen `"gpt"` en su `id`.
  4. **Manejo de Errores**: Si ocurre un problema, devuelve un mensaje de error.

- **Formato de Retorno**: Una lista de diccionarios con `id` y `name` para cada modelo.

#### La Funci贸n `pipe`

- **Prop贸sito**: Maneja la solicitud al modelo seleccionado de OpenAI y devuelve la respuesta.

- **Par谩metros**:
  - `body`: Contiene los datos de la solicitud.
  - `__user__`: Contiene informaci贸n del usuario (no se usa en este ejemplo, pero puede ser 煤til para autenticaci贸n o registro).

- **Proceso**:
  1. **Preparar Encabezados**: Configura los encabezados con la clave API y el tipo de contenido.
  2. **Extraer ID del Modelo**: Extrae el ID real del modelo a partir del nombre seleccionado.
  3. **Preparar Carga til**: Actualiza el cuerpo con el ID correcto del modelo.
  4. **Hacer Solicitud API**: Env铆a una solicitud POST al endpoint de completaciones de chat de la API de OpenAI.
  5. **Manejo de Transmisi贸n**: Si `stream` es `True`, devuelve un iterable de l铆neas.
  6. **Manejo de Errores**: Captura excepciones y devuelve un mensaje de error.

### Extender el Proxy Pipe

Puede modificar este Proxy Pipe para admitir proveedores de servicios adicionales como Anthropic, Perplexity y m谩s ajustando los endpoints de API, encabezados y l贸gica dentro de las funciones `pipes` y `pipe`.

---

## Usando Funciones Internas de Open WebUI

A veces, puede querer aprovechar las funciones internas de Open WebUI dentro de su Pipe. Puede importar estas funciones directamente desde el paquete `open_webui`. Tenga en cuenta que, aunque es poco probable, las funciones internas pueden cambiar por motivos de optimizaci贸n, por lo que siempre consulte la documentaci贸n m谩s reciente.

A continuaci贸n, se muestra c贸mo puede usar funciones internas de Open WebUI:

```python
from pydantic import BaseModel, Field
from fastapi import Request

from open_webui.models.users import Users
de open_webui.utils.chat importar generate_chat_completion

clase Pipe:
    def __init__(self):
        pasar

    async def pipe(
        self,
        body: dict,
        __user__: dict,
        __request__: Request,
    ) -> str:
        # Utiliza el punto de acceso unificado con la firma actualizada
        user = Users.get_user_by_id(__user__["id"])
        body["model"] = "llama3.2:latest"
        return await generate_chat_completion(__request__, body, user)
```

### Explicaci贸n

- **Importaciones**:
  - `Users` desde `open_webui.models.users`: Para obtener informaci贸n del usuario.
  - `generate_chat_completion` desde `open_webui.utils.chat`: Para generar completaciones de chat usando l贸gica interna.

- **Funci贸n As铆ncrona `pipe`**:
  - **Par谩metros**:
    - `body`: Datos de entrada para el modelo.
    - `__user__`: Diccionario que contiene informaci贸n del usuario.
    - `__request__`: El objeto request de FastAPI (requerido por `generate_chat_completion`).
  - **Proceso**:
    1. **Obtener Objeto Usuario**: Recupera el objeto usuario usando su ID.
    2. **Establecer Modelo**: Especifica el modelo a usar.
    3. **Generar Completaci贸n**: Llama a `generate_chat_completion` para procesar la entrada y producir una salida.

### Notas Importantes

- **Firmas de Funci贸n**: Consulta la base de c贸digo o documentaci贸n m谩s reciente de Open WebUI para obtener las firmas y par谩metros m谩s precisos.
- **Mejores Pr谩cticas**: Siempre maneja excepciones y errores de manera elegante para garantizar una experiencia de usuario fluida.

---

## Preguntas Frecuentes

### P1: 驴Por qu茅 deber铆a usar Pipes en Open WebUI?

**R**: Los Pipes te permiten agregar nuevos "modelos" con l贸gica y procesamiento personalizado a Open WebUI. Es un sistema de complementos flexible que te permite integrar APIs externas, personalizar comportamientos de modelos y crear caracter铆sticas innovadoras sin alterar la base de c贸digo principal.

---

### P2: 驴Qu茅 son Valves y por qu茅 son importantes?

**R**: Valves son los par谩metros configurables de tu Pipe. Funcionan como configuraciones o controles que determinan c贸mo opera tu Pipe. Al ajustar Valves, puedes cambiar el comportamiento de tu Pipe sin modificar el c贸digo subyacente.

---

### P3: 驴Puedo crear un Pipe sin Valves?

**R**: S铆, puedes crear un Pipe simple sin definir una clase Valves si tu Pipe no requiere ninguna opci贸n de configuraci贸n persistente. Sin embargo, incluir Valves es una buena pr谩ctica para flexibilidad y escalabilidad futura.

---

### P4: 驴C贸mo aseguro que mi Pipe sea seguro al usar claves de API?

**R**: Nunca codifiques informaci贸n sensible como claves de API directamente en tu Pipe. En su lugar, utiliza Valves para ingresar y almacenar claves de API de manera segura. Aseg煤rate de que tu c贸digo maneje estas claves apropiadamente y evite registrarlas o exponerlas.

---

### P5: 驴Cu谩l es la diferencia entre las funciones `pipe` y `pipes`?

**R**:

- **Funci贸n `pipe`**: La funci贸n principal donde procesas los datos de entrada y generas una salida. Maneja la l贸gica para un solo modelo.

- **Funci贸n `pipes`**: Permite que tu Pipe represente m煤ltiples modelos al devolver una lista de definiciones de modelo. Cada modelo aparecer谩 individualmente en Open WebUI.

---

### P6: 驴C贸mo manejo errores en mi Pipe?

**R**: Usa bloques try-except dentro de tus funciones `pipe` y `pipes` para capturar excepciones. Devuelve mensajes de error significativos o maneja los errores de forma elegante para garantizar que el usuario est茅 informado sobre lo que sali贸 mal.

---

### P7: 驴Puedo usar bibliotecas externas en mi Pipe?

**R**: S铆, puedes importar y usar bibliotecas externas seg煤n sea necesario. Aseg煤rate de que cualquier dependencia est茅 correctamente instalada y gestionada dentro de tu entorno.

---

### P8: 驴C贸mo pruebo mi Pipe?

**R**: Prueba tu Pipe ejecutando Open WebUI en un entorno de desarrollo y seleccionando tu modelo personalizado desde la interfaz. Valida que tu Pipe funcione como se espera con varios inputs y configuraciones.

---

### P9: 驴Existen mejores pr谩cticas para organizar el c贸digo de mi Pipe?

**R**: S铆, sigue estas pautas:

- Mant茅n `Valves` en la parte superior de tu clase `Pipe`.
- Inicializa variables en el m茅todo `__init__`, principalmente `self.valves`.
- Coloca la funci贸n `pipe` despu茅s del m茅todo `__init__`.
- Utiliza nombres de variables claros y descriptivos.
- Comenta tu c贸digo para mayor claridad.

---

### P10: 驴D贸nde puedo encontrar la documentaci贸n m谩s reciente de Open WebUI?

**R**: Visita el repositorio oficial de Open WebUI o el sitio de documentaci贸n para obtener la informaci贸n m谩s actualizada, incluyendo firmas de funciones, ejemplos y gu铆as de migraci贸n si ocurren cambios.

---

## Conclusi贸n

Ahora deber铆as tener una comprensi贸n completa de c贸mo crear y usar Pipes en Open WebUI. Los Pipes ofrecen una manera poderosa de extender y personalizar las capacidades de Open WebUI para adaptarse a tus necesidades espec铆ficas. Ya sea integrando APIs externas, agregando nuevos modelos o inyectando l贸gica compleja, los Pipes brindan la flexibilidad para hacer que esto sea posible.

Recuerda:

- **Usa una estructura clara y consistente** en tus clases de Pipe.
- **Aprovecha Valves** para opciones configurables.
- **Maneja errores de forma elegante** para mejorar la experiencia del usuario.
- **Consulte la documentaci贸n m谩s reciente** para cualquier actualizaci贸n o cambio.

隆Feliz programaci贸n y disfrute extendiendo su Open WebUI con Pipes!
