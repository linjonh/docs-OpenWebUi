---
sidebar_position: 1
title: "üö∞ Fonction Pipe"
---

# üö∞ Fonction Pipe : Cr√©er des "Agents/Mod√®les" Personnalis√©s 
Bienvenue dans ce guide sur la cr√©ation de **Pipes** dans Open WebUI ! Pensez aux Pipes comme un moyen d'**ajouter** un nouveau mod√®le √† Open WebUI. Dans ce document, nous expliquerons ce qu'est un Pipe, comment il fonctionne, et comment vous pouvez cr√©er le v√¥tre pour ajouter une logique et un traitement personnalis√©s √† vos mod√®les Open WebUI. Nous utiliserons des m√©taphores claires et passerons en revue chaque d√©tail pour garantir une compr√©hension compl√®te.


## Introduction aux Pipes

Imaginez Open WebUI comme un **syst√®me de plomberie** o√π les donn√©es circulent √† travers des tuyaux et des vannes. Dans cette analogie :

- Les **Pipes** sont comme des **plugins** qui permettent d'introduire de nouveaux chemins pour le flux de donn√©es, vous permettant d'injecter une logique et un traitement personnalis√©s.
- Les **Vannes** sont les **parties configurables** de votre pipe qui contr√¥lent comment les donn√©es circulent √† travers celui-ci.

En cr√©ant un Pipe, vous concevez essentiellement un mod√®le personnalis√© avec le comportement sp√©cifique que vous souhaitez, tout cela dans le cadre d'Open WebUI.

---

## Comprendre la Structure d'un Pipe

Commen√ßons par une version de base, simplifi√©e, d'un Pipe pour en comprendre la structure :

```python
from pydantic import BaseModel, Field

class Pipe:
    class Valves(BaseModel):
        MODEL_ID: str = Field(default="")

    def __init__(self):
        self.valves = self.Valves()

    def pipe(self, body: dict):
        # La logique va ici
        print(self.valves, body)  # Cela imprimera les options de configuration et le contenu d'entr√©e
        return "Hello, World!"
```

### La Classe Pipe

- **D√©finition** : La classe `Pipe` est o√π vous d√©finissez votre logique personnalis√©e.
- **Objectif** : Sert de mod√®le pour votre plugin, d√©terminant son comportement dans Open WebUI.

### Valves : Configurer Votre Pipe

- **D√©finition** : `Valves` est une classe imbriqu√©e dans `Pipe`, h√©ritant de `BaseModel`.
- **Objectif** : Contient les options de configuration (param√®tres) qui sont conserv√©es tout au long de l'utilisation de votre Pipe.
- **Exemple** : Dans le code ci-dessus, `MODEL_ID` est une option de configuration avec une cha√Æne vide par d√©faut.

**M√©taphore** : Pensez aux Valves comme aux boutons d'un syst√®me de conduite r√©el qui contr√¥lent le d√©bit d'eau. Dans votre Pipe, les Valves permettent aux utilisateurs de ajuster les param√®tres qui influencent comment les donn√©es circulent et sont trait√©es.

### La M√©thode `__init__`

- **D√©finition** : La m√©thode constructeur pour la classe `Pipe`.
- **Objectif** : Initialise l'√©tat du Pipe et pr√©pare les composants n√©cessaires.
- **Bonne Pratique** : Gardez-la simple ; initiez principalement `self.valves` ici.

```python
def __init__(self):
    self.valves = self.Valves()
```

### La Fonction `pipe`

- **D√©finition** : La fonction principale o√π r√©side votre logique personnalis√©e.
- **Param√®tres** :
  - `body` : Un dictionnaire contenant les donn√©es d'entr√©e.
- **Objectif** : Traite les donn√©es d'entr√©e avec votre logique personnalis√©e et renvoie le r√©sultat.

```python
def pipe(self, body: dict):
    # La logique va ici
    print(self.valves, body)  # Cela imprimera les options de configuration et le contenu d'entr√©e
    return "Hello, World!"
```

**Remarque** : Placez toujours `Valves` en haut de votre classe `Pipe`, suivi de `__init__`, puis de la fonction `pipe`. Cette structure garantit clart√© et coh√©rence.

---

## Cr√©er Plusieurs Mod√®les avec les Pipes

Que faire si vous voulez que votre Pipe cr√©e **plusieurs mod√®les** dans Open WebUI ? Vous pouvez y parvenir en d√©finissant une fonction ou une variable `pipes` √† l'int√©rieur de votre classe `Pipe`. Ce concept, informellement appel√© un **collecteur**, permet √† votre Pipe de repr√©senter plusieurs mod√®les.

Voici comment le faire :

```python
from pydantic import BaseModel, Field

class Pipe:
    class Valves(BaseModel):
        MODEL_ID: str = Field(default="")

    def __init__(self):
        self.valves = self.Valves()

    def pipes(self):
        return [
            {"id": "model_id_1", "name": "model_1"},
            {"id": "model_id_2", "name": "model_2"},
            {"id": "model_id_3", "name": "model_3"},
        ]

    def pipe(self, body: dict):
        # La logique va ici
        print(self.valves, body)  # Imprime les options de configuration et le contenu d'entr√©e
        model = body.get("model", "")
        return f"{model}: Hello, World!"
```

### Explications

- **Fonction `pipes`** :
  - Renvoie une liste de dictionnaires.
  - Chaque dictionnaire repr√©sente un mod√®le avec des cl√©s uniques `id` et `name`.
  - Ces mod√®les appara√Ætront individuellement dans le s√©lecteur de mod√®le d'Open WebUI.

- **Fonction `pipe` Mise √† Jour** :
  - Traite les donn√©es d'entr√©e en fonction du mod√®le s√©lectionn√©.
  - Dans cet exemple, inclut le nom du mod√®le dans la cha√Æne retourn√©e.

---

## Exemple : Pipe Proxy pour OpenAI

Passons √† un exemple pratique o√π nous allons cr√©er un Pipe qui transmet les requ√™tes √† l'API OpenAI. Ce Pipe r√©cup√©rera les mod√®les disponibles d'OpenAI et permettra aux utilisateurs d'interagir avec eux via Open WebUI.

```python
from pydantic import BaseModel, Field
import requests

class Pipe:
    class Valves(BaseModel):
        NAME_PREFIX: str = Field(
            default="OPENAI",
            description="Pr√©fixe √† ajouter avant les noms des mod√®les.",
        )
        OPENAI_API_BASE_URL: str = Field(
            default="https://api.openai.com/v1",
            description="URL de base pour acc√©der aux points de terminaison de l'API OpenAI.",
        )
        OPENAI_API_KEY: str = Field(
            default="",
            description="Cl√© API pour authentifier les requ√™tes vers l'API OpenAI.",
        )

    def __init__(self):
        self.valves = self.Valves()

    def pipes(self):
        if self.valves.OPENAI_API_KEY:
            try:
                headers = {
                    "Authorization": f"Bearer {self.valves.OPENAI_API_KEY}",
                    "Content-Type": "application/json",
                }

                r = requests.get(
                    f"{self.valves.OPENAI_API_BASE_URL}/models", headers=headers
                )
                models = r.json()
                return [
                    {
                        "id": model["id"],
                        "name": f{self.valves.NAME_PREFIX}{model.get("name", model["id"])},
                    }
                    for model in models["data"]
                    if "gpt" in model["id"]
                ]

            except Exception as e:
                return [
                    {
                        "id": "error",
                        "name": "Erreur lors de la r√©cup√©ration des mod√®les. Veuillez v√©rifier votre cl√© API.",
                    },
                ]
        else:
            return [
                {
                    "id": "error",
                    "name": "Cl√© API non fournie.",
                },
            ]

    def pipe(self, body: dict, __user__: dict):
        print(f"pipe:{__name__}")
        headers = {
            "Authorization": f"Bearer {self.valves.OPENAI_API_KEY}",
            "Content-Type": "application/json",
        }

        # Extraire l'identifiant du mod√®le √† partir du nom du mod√®le
        model_id = body["model"][body["model"].find(".") + 1 :]

        # Mettre √† jour l'identifiant du mod√®le dans le corps de la requ√™te
        payload = {**body, "model": model_id}
        try:
            r = requests.post(
                url=f"{self.valves.OPENAI_API_BASE_URL}/chat/completions",
                json=payload,
                headers=headers,
                stream=True,
            )

            r.raise_for_status()

            if body.get("stream", False):
                return r.iter_lines()
            else:
                return r.json()
        except Exception as e:
            return f"Erreur : {e}"
```

### D√©composition d√©taill√©e

#### Configuration des Valves

- **`NAME_PREFIX`**:
  - Ajoute un pr√©fixe aux noms des mod√®les affich√©s dans Open WebUI.
  - Par d√©faut : `"OPENAI/"`.
- **`OPENAI_API_BASE_URL`**:
  - Sp√©cifie l'URL de base pour l'API OpenAI.
  - Par d√©faut : `"https://api.openai.com/v1"`.
- **`OPENAI_API_KEY`**:
  - Votre cl√© API OpenAI pour l'authentification.
  - Par d√©faut : `""` (chaine vide ; doit √™tre fournie).

#### La fonction `pipes`

- **But** : R√©cup√®re les mod√®les disponibles de l'API OpenAI et les rend accessibles dans Open WebUI.

- **Processus** :
  1. **V√©rifier la cl√© API** : S'assure qu'une cl√© API est fournie.
  2. **R√©cup√©rer les mod√®les** : Effectue une requ√™te GET vers l'API OpenAI pour r√©cup√©rer les mod√®les disponibles.
  3. **Filtrer les mod√®les** : Renvoie les mod√®les qui contiennent `"gpt"` dans leur `id`.
  4. **Gestion des erreurs** : En cas de probl√®me, renvoie un message d'erreur.

- **Format de retour** : Une liste de dictionnaires avec `id` et `name` pour chaque mod√®le.

#### La fonction `pipe`

- **But** : G√®re la requ√™te vers le mod√®le OpenAI s√©lectionn√© et renvoie la r√©ponse.

- **Param√®tres** :
  - `body` : Contient les donn√©es de la requ√™te.
  - `__user__` : Contient les informations sur l'utilisateur (non utilis√© dans cet exemple mais peut √™tre utile pour l'authentification ou la journalisation).

- **Processus** :
  1. **Pr√©parer les en-t√™tes** : Configure les en-t√™tes avec la cl√© API et le type de contenu.
  2. **Extraire l'identifiant du mod√®le** : Extrait l'identifiant r√©el du mod√®le √† partir du nom s√©lectionn√©.
  3. **Pr√©parer les donn√©es** : Met √† jour le corps de la requ√™te avec l'identifiant correct du mod√®le.
  4. **Effectuer la requ√™te API** : Envoie une requ√™te POST au point de terminaison des compl√©tions de chat de l'API OpenAI.
  5. **G√©rer le flux** : Si `stream` est `True`, renvoie un it√©rable de lignes.
  6. **Gestion des erreurs** : Intercepte les exceptions et renvoie un message d'erreur.

### Extension du Pipe proxy

Vous pouvez modifier ce Pipe proxy pour prendre en charge d'autres fournisseurs de services comme Anthropic, Perplexity, et plus encore en ajustant les points de terminaison API, les en-t√™tes et la logique dans les fonctions `pipes` et `pipe`.

---

## Utilisation des fonctions internes de Open WebUI

Parfois, vous voudrez peut-√™tre utiliser les fonctions internes de Open WebUI dans votre Pipe. Vous pouvez importer directement ces fonctions depuis le package `open_webui`. Gardez √† l'esprit que, bien que peu probable, les fonctions internes peuvent changer √† des fins d'optimisation. Consultez toujours la documentation la plus r√©cente.

Voici comment utiliser les fonctions internes de Open WebUI :

```python
from pydantic import BaseModel, Field
from fastapi import Request

from open_webui.models.users import Users
depuis open_webui.utils.chat import generate_chat_completion

class Pipe:
    def __init__(self):
        pass

    async def pipe(
        self,
        body: dict,
        __user__: dict,
        __request__: Request,
    ) -> str:
        # Utilisez le point de terminaison unifi√© avec la signature mise √† jour
        user = Users.get_user_by_id(__user__["id"])
        body["model"] = "llama3.2:latest"
        return await generate_chat_completion(__request__, body, user)
```

### Explication

- **Importations**:
  - `Users` depuis `open_webui.models.users`: Pour r√©cup√©rer les informations sur l'utilisateur.
  - `generate_chat_completion` depuis `open_webui.utils.chat`: Pour g√©n√©rer des compl√©tions de chat en utilisant la logique interne.

- **Fonction asynchrone `pipe`**:
  - **Param√®tres**:
    - `body`: Donn√©es d'entr√©e pour le mod√®le.
    - `__user__`: Dictionnaire contenant les informations sur l'utilisateur.
    - `__request__`: L'objet de la requ√™te depuis FastAPI (n√©cessaire pour `generate_chat_completion`).
  - **Processus**:
    1. **R√©cup√©rer l'objet utilisateur**: R√©cup√®re l'objet utilisateur en utilisant son ID.
    2. **D√©finir le mod√®le**: Sp√©cifie le mod√®le √† utiliser.
    3. **G√©n√©rer la compl√©tion**: Appelle `generate_chat_completion` pour traiter les donn√©es d'entr√©e et produire un r√©sultat.

### Remarques importantes

- **Signatures des fonctions**: Consultez la base de code ou la documentation la plus r√©cente d'Open WebUI pour les signatures et param√®tres de fonctions les plus pr√©cis.
- **Bonnes pratiques**: G√©rez toujours les exceptions et les erreurs de mani√®re gracieuse pour garantir une exp√©rience utilisateur fluide.

---

## Questions Fr√©quemment Pos√©es

### Q1 : Pourquoi devrais-je utiliser des Pipes dans Open WebUI ?

**R** : Les Pipes vous permettent d'ajouter de nouveaux "mod√®les" avec une logique et un traitement personnalis√©s √† Open WebUI. C'est un syst√®me de plugin flexible qui vous permet d'int√©grer des APIs externes, de personnaliser les comportements des mod√®les, et de cr√©er des fonctionnalit√©s innovantes sans modifier la base de code principale.

---

### Q2 : Que sont les Valves, et pourquoi sont-elles importantes ?

**R** : Les Valves sont les param√®tres configurables de votre Pipe. Elles fonctionnent comme des r√©glages ou des contr√¥les qui d√©terminent comment votre Pipe fonctionne. En ajustant les Valves, vous pouvez changer le comportement de votre Pipe sans modifier le code sous-jacent.

---

### Q3 : Puis-je cr√©er un Pipe sans Valves ?

**R** : Oui, vous pouvez cr√©er un Pipe simple sans d√©finir une classe de Valves si votre Pipe ne n√©cessite aucune option de configuration persistante. Cependant, inclure des Valves est une bonne pratique pour plus de flexibilit√© et d'√©volutivit√©.

---

### Q4 : Comment puis-je m'assurer que mon Pipe est s√©curis√© lors de l'utilisation de cl√©s API ?

**R** : Ne jamais coder en dur des informations sensibles comme les cl√©s API dans votre Pipe. Utilisez plut√¥t les Valves pour saisir et stocker les cl√©s API de mani√®re s√©curis√©e. Assurez-vous que votre code g√®re ces cl√©s de mani√®re appropri√©e et √©vite de les enregistrer ou de les exposer.

---

### Q5 : Quelle est la diff√©rence entre les fonctions `pipe` et `pipes` ?

**R** :

- **Fonction `pipe`**: La fonction principale o√π vous traitez les donn√©es d'entr√©e et g√©n√©rez une sortie. Elle g√®re la logique pour un seul mod√®le.

- **Fonction `pipes`**: Permet √† votre Pipe de repr√©senter plusieurs mod√®les en renvoyant une liste de d√©finitions de mod√®les. Chaque mod√®le appara√Ætra individuellement dans Open WebUI.

---

### Q6 : Comment puis-je g√©rer les erreurs dans mon Pipe ?

**R** : Utilisez des blocs try-except dans vos fonctions `pipe` et `pipes` pour capturer les exceptions. Renvoyez des messages d'erreur significatifs ou g√©rez les erreurs de mani√®re gracieuse pour informer l'utilisateur de ce qui s'est mal pass√©.

---

### Q7 : Puis-je utiliser des biblioth√®ques externes dans mon Pipe ?

**R** : Oui, vous pouvez importer et utiliser des biblioth√®ques externes selon vos besoins. Assurez-vous que toutes les d√©pendances sont correctement install√©es et g√©r√©es dans votre environnement.

---

### Q8 : Comment puis-je tester mon Pipe ?

**R** : Testez votre Pipe en ex√©cutant Open WebUI dans un environnement de d√©veloppement et en s√©lectionnant votre mod√®le personnalis√© depuis l'interface. Validez que votre Pipe comporte comme pr√©vu avec diverses entr√©es et configurations.

---

### Q9 : Existe-t-il des meilleures pratiques pour organiser le code de mon Pipe ?

**R** : Oui, suivez ces lignes directrices :

- Placez `Valves` en haut de votre classe `Pipe`.
- Initialisez les variables dans la m√©thode `__init__`, principalement `self.valves`.
- Positionnez la fonction `pipe` apr√®s la m√©thode `__init__`.
- Utilisez des noms de variables clairs et descriptifs.
- Commentez votre code pour plus de clart√©.

---

### Q10 : O√π puis-je trouver la documentation r√©cente d'Open WebUI ?

**R** : Visitez le repository officiel d'Open WebUI ou le site de documentation pour obtenir les informations les plus √† jour, y compris les signatures de fonctions, des exemples, et des guides de migration si des changements ont lieu.

---

## Conclusion

Vous devriez √† pr√©sent avoir une compr√©hension approfondie de la fa√ßon de cr√©er et d'utiliser des Pipes dans Open WebUI. Les Pipes offrent un moyen puissant d'√©tendre et de personnaliser les capacit√©s d'Open WebUI pour r√©pondre √† vos besoins sp√©cifiques. Que vous int√©griez des APIs externes, ajoutiez de nouveaux mod√®les ou injectiez une logique complexe, les Pipes fournissent la flexibilit√© n√©cessaire pour y parvenir.

N'oubliez pas :

- **Utilisez une structure claire et coh√©rente** dans vos classes Pipe.
- **Exploitez les Valves** pour des options configurables.
- **G√©rez les erreurs de mani√®re gracieuse** pour am√©liorer l'exp√©rience utilisateur.
- **Consultez la documentation la plus r√©cente** pour toute mise √† jour ou modification.

Bon codage, et amusez-vous √† √©tendre votre Open WebUI avec des Pipes !
