---
sidebar_position: 2
title: "ü™Ñ Fonction de Filtre"
---

# ü™Ñ Fonction de Filtre : Modifier les Entr√©es et Sorties

Bienvenue dans le guide complet sur les Fonctions de Filtre dans Open WebUI ! Les filtres sont un syst√®me de **plugin** flexible et puissant pour modifier les donn√©es *avant qu'elles ne soient envoy√©es au Mod√®le de Langage de Grande Taille (LLM)* (entr√©e) ou *apr√®s leur retour du LLM* (sortie). Que vous transformiez les entr√©es pour un meilleur contexte ou nettoyiez les sorties pour une lisibilit√© am√©lior√©e, les **Fonctions de Filtre** vous permettent de tout faire.

Ce guide d√©composera **ce que sont les Filtres**, comment ils fonctionnent, leur structure, et tout ce que vous devez savoir pour cr√©er vos propres filtres puissants et conviviaux. Allons-y, et ne vous inqui√©tez pas‚Äîj'utiliserai des m√©taphores, des exemples et des astuces pour rendre tout cela limpide ! üåü

---

## üåä Que sont les Filtres dans Open WebUI ?

Imaginez Open WebUI comme un **flux d'eau** s'√©coulant √† travers des tuyaux :

- Les **entr√©es utilisateur** et les **sorties du LLM** sont l'eau.
- Les **Filtres** sont les **√©tapes de traitement de l'eau** qui nettoient, modifient et adaptent l'eau avant qu'elle n'atteigne sa destination finale.

Les filtres se positionnent au milieu du flux‚Äîcomme des points de contr√¥le‚Äîo√π vous d√©cidez de ce qui doit √™tre ajust√©.

Voici un r√©sum√© rapide de ce que font les Filtres :

1. **Modifier les Entr√©es Utilisateur (Fonction d'Entr√©e)** : Ajustez les donn√©es d'entr√©e avant qu'elles n'atteignent le mod√®le IA. C'est l√† o√π vous am√©liorez la clart√©, ajoutez du contexte, assainissez le texte ou reformatez les messages pour r√©pondre √† des exigences sp√©cifiques.
2. **Intercepter les Sorties du Mod√®le (Fonction de Flux)** : Capturez et ajustez les r√©ponses de l'IA **pendant leur g√©n√©ration** par le mod√®le. Cela est utile pour les modifications en temps r√©el, comme le filtrage des informations sensibles ou le formatage des sorties pour une meilleure lisibilit√©.
3. **Modifier les Sorties du Mod√®le (Fonction de Sortie)** : Ajustez les r√©ponses de l'IA **apr√®s leur traitement**, avant de les montrer √† l'utilisateur. Cela peut aider √† affiner, journaliser ou adapter les donn√©es pour une exp√©rience utilisateur plus nette.

> **Concept Cl√© :** Les Filtres ne sont pas des mod√®les autonomes mais des outils qui am√©liorent ou transforment les donn√©es circulant *vers* et *depuis* les mod√®les.

Les filtres sont comme des **traducteurs ou √©diteurs** dans le flux de travail IA : vous pouvez intercepter et modifier la conversation sans interrompre le flux.

---

## üó∫Ô∏è Structure d'une Fonction de Filtre : Le Squelette

Commen√ßons par la repr√©sentation la plus simple d'une Fonction de Filtre. Ne vous inqui√©tez pas si certaines parties vous semblent techniques au d√©but‚Äînous allons tout d√©cortiquer √©tape par √©tape !

### ü¶¥ Squelette de Base d'un Filtre

```python
from pydantic import BaseModel
from typing import Optional

class Filter:
    # Vannes : Options de configuration pour le filtre
    class Valves(BaseModel):  
        pass

    def __init__(self):
        # Initialiser les vannes (configuration optionnelle pour le Filtre)
        self.valves = self.Valves()

    def inlet(self, body: dict) -> dict:
        # C'est ici que vous manipulez les entr√©es utilisateur.
        print(f"inlet appel√© : {body}")
        return body  

    def stream(self, event: dict) -> dict:
        # C'est ici que vous modifiez les blocs de sortie g√©n√©r√©s par le mod√®le.
        print(f"√©v√©nement de flux : {event}")
        return event

    def outlet(self, body: dict) -> None:
        # C'est ici que vous manipulez les sorties du mod√®le.
        print(f"outlet appel√© : {body}")
```

---

### üÜï üß≤ Exemple de Filtre √† Interrupteur : Ajouter de l'Interactivit√© et des Ic√¥nes (Nouveau dans Open WebUI 0.6.10)

Les filtres peuvent faire plus que simplement modifier du texte‚Äîils peuvent exposer des interrupteurs dans l'interface utilisateur et afficher des ic√¥nes personnalis√©es. Par exemple, vous pourriez vouloir un filtre activable/d√©sactivable avec un bouton d'interface utilisateur, et affichant une ic√¥ne sp√©ciale dans l'interface utilisateur d'entr√©e de message d'Open WebUI.

Voici comment vous pourriez cr√©er un tel filtre √† interrupteur :

```python
from pydantic import BaseModel, Field
from typing import Optional

class Filter:
    class Valves(BaseModel):
        pass

    def __init__(self):
        self.valves = self.Valves()
        self.toggle = True # IMPORTANT : Cela cr√©e un interrupteur dans Open WebUI
        # ASTUCE : Utilisez les URI Data SVG !
        self.icon = """data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGZpbGw9Im5vbmUiIHZpZXdCb3g9IjAgMCAyNCAyNCIgc3Ryb2tlLXdpZHRoPSIxLjUiIHN0cm9rZT0iY3VycmVudENvbG9yIiBjbGFzcz0ic2l6ZS02Ij4KICA8cGF0aCBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGQ9Ik0xMiAxOHYtNS4yNW0wIDBhNi4wMSA2LjAxIDAgMCAwIDEuNS0uMTg5bS0xLjUuMTg5YTYuMDEgNi4wMSAwIDAgMS0xLjUtLjE4OW0zLjc1IDcuNDc4YTEyLjA2IDEyLjA2IDAgMCAxLTQuNSAwbTMuNzUgMi4zODNhMTQuNDA2IDE0LjQwNiAwIDAgMS0zIDBNMTQuMjUgMTh2LS4xOTJjMC0uOTgzLjY1OC0xLjgyMyAxLjUwOC0yLjMxNmE3LjUgNy41IDAgMSAwLTcuNTE3IDBjLjg1LjQ5MyAxLjUwOSAxLjMzMyAxLjUwOSAyLjMxNlYxOCIgLz4KPC9zdmc+Cg=="""
        pass

    async def inlet(
        self, body: dict, __event_emitter__, __user__: Optional[dict] = None
    ) -> dict:
        await __event_emitter__(
            {
                "type": "status",
                "data": {
                    "description": "Activ√© !",
                    "done": True,
                    "hidden": False,
                },
            }
        )
        return body
```

#### üñºÔ∏è Que se passe-t-il ?
- **toggle = True** cr√©e une interface utilisateur √† interrupteur dans Open WebUI ‚Äî les utilisateurs peuvent activer ou d√©sactiver le filtre manuellement en temps r√©el.
- **icon** (avec une URI de donn√©es) appara√Ætra comme une petite image √† c√¥t√© du nom du filtre. Vous pouvez utiliser n'importe quel SVG tant qu'il est encod√© en URI de donn√©es !
- **La fonction `inlet`** utilise l'argument sp√©cial `__event_emitter__` pour diffuser des retours d'information ou un statut √† l'interface, comme une petite notification indiquant "Bascul√© !"

![Filtre √† bascule](/images/features/plugin/functions/toggle-filter.png)

Vous pouvez utiliser ces m√©canismes pour rendre vos filtres dynamiques, interactifs et visuellement uniques au sein de l'√©cosyst√®me des plugins d'Open WebUI.

---

### üéØ Explication des composants cl√©s

#### 1Ô∏è‚É£ **Classe `Valves` (Param√®tres optionnels)**

Consid√©rez **Valves** comme les boutons et curseurs pour votre filtre. Si vous souhaitez offrir aux utilisateurs des options configurables pour ajuster le comportement de votre filtre, vous les d√©finissez ici.

```python
class Valves(BaseModel):
    OPTION_NAME: str = "Valeur par d√©faut"
```

Par exemple :
Si vous cr√©ez un filtre qui convertit les r√©ponses en majuscules, vous pourriez permettre aux utilisateurs de configurer si chaque sortie doit √™tre totalement mise en majuscule via une valve comme `TRANSFORM_UPPERCASE: bool = True/False`.

---

#### 2Ô∏è‚É£ **Fonction `inlet` (Pr√©traitement de l'entr√©e)**


La fonction `inlet` est comme **pr√©parer les aliments avant la cuisson**. Imaginez que vous √™tes un chef : avant que les ingr√©dients n'entrent dans la recette (le LLM dans ce cas), vous pourriez laver les l√©gumes, couper les oignons ou assaisonner la viande. Sans cette √©tape, votre plat final pourrait manquer de saveur, avoir des produits non lav√©s ou simplement √™tre incoh√©rent.

Dans le monde d'Open WebUI, la fonction `inlet` fait ce travail de pr√©paration important sur **l'entr√©e utilisateur** avant qu'elle ne soit envoy√©e au mod√®le. Elle garantit que l'entr√©e est aussi propre, contextuelle et utile que possible pour que l'IA puisse la traiter.

üì• **Entr√©e** :
- **`body`** : L'entr√©e brute d'Open WebUI vers le mod√®le. Elle se pr√©sente sous la forme d'une requ√™te de chat (g√©n√©ralement un dictionnaire qui inclut des champs comme les messages de la conversation, les param√®tres du mod√®le et d'autres m√©tadonn√©es). Consid√©rez cela comme vos ingr√©dients de recette.

üöÄ **Votre t√¢che** :
Modifiez et renvoyez le `body`. La version modifi√©e du `body` est celle avec laquelle le LLM travaille, donc c'est votre chance d'apporter de la clart√©, de la structure et du contexte √† l'entr√©e.


##### üç≥ Pourquoi utiliser le `inlet` ?
1. **Ajouter du contexte** : Ajoutez automatiquement des informations cruciales √† l'entr√©e de l'utilisateur, surtout si son texte est vague ou incomplet. Par exemple, vous pourriez ajouter "Vous √™tes un assistant amical" ou "Aidez cet utilisateur √† r√©soudre un probl√®me logiciel."
   
2. **Formater les donn√©es** : Si l'entr√©e n√©cessite un format sp√©cifique, comme JSON ou Markdown, vous pouvez la transformer avant de l'envoyer au mod√®le.

3. **Nettoyer l'entr√©e** : Supprimez les caract√®res ind√©sirables, enlevez les symboles potentiellement nuisibles ou d√©routants (comme des espaces excessifs ou des emojis), ou remplacez les informations sensibles.

4. **Rationaliser l'entr√©e utilisateur** : Si la sortie de votre mod√®le s'am√©liore gr√¢ce √† des indications suppl√©mentaires, vous pouvez utiliser le `inlet` pour injecter automatiquement des instructions clarificatrices !


##### üí° Cas d'utilisation : Construisez sur la pr√©paration des aliments
###### ü•ó Exemple 1 : Ajouter du contexte syst√©mique
Disons que le LLM est un chef pr√©parant un plat pour une cuisine italienne, mais l'utilisateur n'a pas mentionn√© "Ceci est pour la cuisine italienne." Vous pouvez vous assurer que le message est clair en ajoutant ce contexte avant d'envoyer les donn√©es au mod√®le.

```python
def inlet(self, body: dict, __user__: Optional[dict] = None) -> dict:
    # Ajouter un message syst√®me pour un contexte italien dans la conversation
    context_message = {
        "role": "system",
        "content": "Vous aidez l'utilisateur √† pr√©parer un repas italien."
    }
    # Ins√©rer le contexte au d√©but de l'historique de chat
    body.setdefault("messages", []).insert(0, context_message)
    return body
```

üìñ **Que se passe-t-il ?**
- Toute entr√©e utilisateur comme "Quelles sont de bonnes id√©es de d√Æner ?" porte maintenant le th√®me italien parce que nous avons d√©fini le contexte syst√®me ! Le cheesecake pourrait ne pas appara√Ætre comme une r√©ponse, mais les p√¢tes certainement.


###### üî™ Exemple 2 : Nettoyer l'entr√©e (Enlever les caract√®res √©tranges)
Supposons que l'entr√©e de l'utilisateur semble d√©sordonn√©e ou inclut des symboles ind√©sirables comme `!!!`, rendant la conversation inefficace ou plus difficile √† analyser pour le mod√®le. Vous pouvez la nettoyer tout en conservant le contenu principal.

```python
def inlet(self, body: dict, __user__: Optional[dict] = None) -> dict:
    # Nettoyer la derni√®re entr√©e utilisateur (√† partir de la fin de la liste 'messages')
    last_message = body["messages"][-1]["content"]
    body["messages"][-1]["content"] = last_message.replace("!!!", "").strip()
    return body
```

üìñ **Que se passe-t-il ?**
- Avant : `"Comment puis-je d√©panner ce probl√®me !!!"` ‚û°Ô∏è Envoy√© au mod√®le comme `"Comment puis-je d√©panner ce probl√®me"`

Note : L'utilisateur ressent la m√™me chose, mais le mod√®le traite une requ√™te plus propre et plus facile √† comprendre.


##### üìä Comment `inlet` contribue √† optimiser l'entr√©e pour le LLM :
- Am√©liore **la pr√©cision** en clarifiant les requ√™tes ambigu√´s.
- Rend l'IA **plus efficace** en √©liminant les bruits inutiles comme les emojis, les balises HTML ou les ponctuations suppl√©mentaires.
- Garantit **la coh√©rence** en formatant les entr√©es utilisateur pour correspondre aux sch√©mas ou mod√®les attendus (comme, disons, le JSON pour un cas d'utilisation sp√©cifique).


üí≠ **Pensez √† `inlet` comme un sous-chef dans votre cuisine**‚Äîassurant que tout ce qui entre dans le mod√®le (votre "recette" d'IA) a √©t√© pr√©par√©, nettoy√© et assaisonn√© √† la perfection. Meilleure est l'entr√©e, meilleur est le r√©sultat !

---

#### üÜï 3Ô∏è‚É£ **Hook `stream` (Nouveau dans Open WebUI 0.5.17)**

##### üîÑ Qu'est-ce que le hook `stream` ?
La **fonction `stream`** est une nouvelle fonctionnalit√© introduite dans Open WebUI **0.5.17** qui vous permet d'**intercepter et modifier les r√©ponses du mod√®le en streaming** en temps r√©el.

Contrairement √† `outlet`, qui traite une r√©ponse compl√®te, `stream` fonctionne sur des **fragments individuels** au fur et √† mesure qu'ils sont re√ßus du mod√®le.

##### üõ†Ô∏è Quand utiliser le hook Stream ?
- Modifier les **r√©ponses en streaming** avant qu'elles ne soient affich√©es aux utilisateurs.
- Impl√©menter une **censure ou un nettoyage en temps r√©el**.
- **Superviser les donn√©es stream√©es** pour le journal ou le d√©bogage.

##### üìú Exemple : Journaliser les fragments en streaming

Voici comment inspecter et modifier les r√©ponses LLM diffus√©es :
```python
def stream(self, event: dict) -> dict:
    print(event)  # Affiche chaque fragment entrant pour inspection
    return event
```

> **Exemple d'√©v√©nements stream√©s :**
```jsonl
{"id": "chatcmpl-B4l99MMaP3QLGU5uV7BaBM0eDS0jb","choices": [{"delta": {"content": "Salut"}}]}
{"id": "chatcmpl-B4l99MMaP3QLGU5uV7BaBM0eDS0jb","choices": [{"delta": {"content": "!"}}]}
{"id": "chatcmpl-B4l99MMaP3QLGU5uV7BaBM0eDS0jb","choices": [{"delta": {"content": " üòä"}}]}
```
üìñ **Que se passe-t-il ?**
- Chaque ligne repr√©sente un **petit fragment** de la r√©ponse en streaming du mod√®le.
- Le champ **`delta.content`** contient le texte g√©n√©r√© progressivement.

##### üîÑ Exemple : Filtrer les emojis des donn√©es en streaming
```python
def stream(self, event: dict) -> dict:
    for choice in event.get("choices", []):
        delta = choice.get("delta", {})
        if "content" in delta:
            delta["content"] = delta["content"].replace("üòä", "")  # Retirer les emojis
    return event
```
üìñ **Avant :** `"Salut üòä"`  
üìñ **Apr√®s :** `"Salut"`

---

#### 4Ô∏è‚É£ **Fonction `outlet` (Post-traitement de la sortie)**

La fonction `outlet` agit comme un **correcteur** : elle nettoie la r√©ponse de l'IA (ou y apporte des modifications finales) *apr√®s son traitement par le LLM.*

üì§ **Entr√©e :**
- **`body`** : Cela contient **tous les messages actuels** dans la discussion (historique de l'utilisateur + r√©ponses de LLM).

üöÄ **Votre t√¢che :** Modifier ce `body`. Vous pouvez le nettoyer, le compl√©ter ou enregistrer les changements, mais soyez attentif √† l'impact de chaque ajustement sur l'exp√©rience utilisateur.

üí° **Bonnes pratiques :**
- Pr√©f√©rez la journalisation aux modifications directes dans `outlet` (par exemple, pour le d√©bogage ou l'analyse).
- Si des modifications importantes sont n√©cessaires (comme le formatage des sorties), envisagez d'utiliser plut√¥t la **fonction pipe**.

üí° **Utilisation :** Supprimez les informations sensibles d'API que vous ne voulez pas montrer √† l'utilisateur :
```python
def outlet(self, body: dict, __user__: Optional[dict] = None) -> dict:
    for message in body["messages"]:
        message["content"] = message["content"].replace("<API_KEY>", "[REDACTED]")
    return body
```

---

## üåü Filtres en action : Cr√©er des exemples pratiques

Construisons quelques exemples concrets pour voir comment utiliser les filtres !

### üìö Exemple #1 : Ajouter un contexte √† chaque entr√©e utilisateur

Vous voulez que le LLM sache toujours qu'il aide un client √† r√©soudre des bogues logiciels ? Vous pouvez ajouter des instructions comme **"Vous √™tes un assistant de d√©pannage logiciel"** √† chaque requ√™te utilisateur.

```python
class Filter:
    def inlet(self, body: dict, __user__: Optional[dict] = None) -> dict:
        context_message = {
            "role": "system", 
            "content": "Vous √™tes un assistant de d√©pannage logiciel."
        }
        body.setdefault("messages", []).insert(0, context_message)
        return body
```

---

### üìö Exemple #2 : Mettre en √©vidence les sorties pour une lecture facile

Retourner une sortie en Markdown ou dans un autre style format√© ? Utilisez la fonction `outlet` !

```python
class Filter:
    def outlet(self, body: dict, __user__: Optional[dict] = None) -> dict:
        # Ajouter le markdown "highlight" pour chaque r√©ponse
        for message in body["messages"]:
            if message["role"] == "assistant":  # Cibler la r√©ponse du mod√®le
                message["content"] = f"**{message[content]}**"  # Mettre en surbrillance avec Markdown
        return body
```

---

## üöß Confusions potentielles : FAQ claires üõë

### **Q : En quoi les filtres diff√®rent-ils des fonctions pipe ?**

Les filtres modifient les donn√©es **allant vers** et **revenant des mod√®les** mais n'interagissent pas de mani√®re significative avec la logique en dehors de ces phases. Les pipes, en revanche :
- Peuvent int√©grer des **API externes** ou transformer significativement les op√©rations du backend.
- Exposent une logique personnalis√©e comme de v√©ritables "mod√®les".

### **Q : Puis-je faire un post-traitement lourd dans `outlet` ?**

Vous pouvez, mais **ce n‚Äôest pas la meilleure pratique.**:
- **Les filtres** sont con√ßus pour effectuer des modifications l√©g√®res ou appliquer une journalisation.
- Si des modifications importantes sont n√©cessaires, envisagez plut√¥t une **fonction Pipe**.

---

## üéâ R√©capitulatif : Pourquoi cr√©er des fonctions de filtre ?

√Ä ce stade, vous avez appris :
1. **Inlet** manipule les **entr√©es utilisateur** (pr√©traitement).
2. **Stream** intercepte et modifie les **sorties de mod√®les en streaming** (en temps r√©el).
3. **Outlet** ajuste les **sorties de l'IA** (post-traitement).
4. Les filtres sont id√©aux pour les modifications l√©g√®res et en temps r√©el du flux de donn√©es.
5. Avec **Valves**, vous permettez aux utilisateurs de configurer dynamiquement les filtres pour un comportement sur mesure.

---

üöÄ **√Ä vous de jouer** : Commencez √† exp√©rimenter ! Quelle petite modification ou ajout contextuel pourrait am√©liorer votre exp√©rience avec Open WebUI ? Les filtres sont amusants √† cr√©er, flexibles √† utiliser et peuvent faire passer vos mod√®les au niveau sup√©rieur !

Bon codage ! ‚ú®
