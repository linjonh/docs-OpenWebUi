---
sidebar_position: 3
title: "🧠 RAG（検索強化生成）のトラブルシューティング"
---

検索強化生成（RAG）は、言語モデルが外部コンテンツ（文書、知識ベースなど）を利用して推論を行うことを可能にします。これは関連情報を検索してモデルに入力することで実現されます。しかし、期待通りに動作しない場合（例: モデルが「幻覚」を起こしたり、関連情報を見落としたりする場合）、原因は通常モデル自体ではなく、コンテキストの問題です。

RAGの精度を向上させるために、よくある原因とその解決策を分解してみましょう！🚀

## よくあるRAGの課題とその解決方法 🛠️

### 1. モデルがコンテンツを「見えない」👁️❌

これは最も一般的な問題であり、通常はコンテンツのインジェストプロセス中の問題によって発生します。モデルが「幻覚」を起こすのは誤ったからではなく、適切なコンテンツが最初からモデルに提供されていなかったからです。

✅ 解決策: コンテンツ抽出設定を確認

- **管理設定 > 文書**に移動。
- 以下のような信頼性の高いコンテンツ抽出エンジンを使用していることを確認してください：
  - Apache Tika
  - Docling
  - カスタム抽出ツール（文書の種類に応じて）

📌 ヒント: 文書をアップロードして抽出されたコンテンツをプレビューしてみてください。空白になっていたり重要なセクションが欠落している場合は、抽出設定を調整するか別のエンジンを使用してください。

---

### 2. 文書の一部しか使用されていない 📄➡️✂️

Open WebUIはデフォルトでコンテキストウィンドウが限られているモデルと連携するよう設計されています。例えば、多くのローカルモデル（例: Ollamaのデフォルトモデル）は2048トークンに制限されています。このため、Open WebUIは取得したコンテンツを積極的にトリミングし、利用可能なスペースに収まるようにしています。

✅ 解決策:

- **管理設定 > 文書**に移動
- 次のどちらかを選択：
  - 💡「埋め込みと検索をバイパス」を有効化—厳密な検索フィルターを適用せずに完全なコンテンツを直接送信します。
  - 🔍「完全コンテキストモード」をオンにする—より包括的なコンテンツをモデルプロンプトに注入します。

📌 警告: コンテキストの制限に注意してください—モデルが多くのトークンを処理できない場合、切り捨てられます。

---

### 3. トークンの制限が短すぎる ⏳

検索がうまくいっても、モデルが受け取ったすべてのコンテンツを処理できないことがあります—単に処理能力を超えている場合です。

デフォルトでは、多くのモデル（特にOllamaホストのLLM）は2048トークンのコンテキストウィンドウに制限されています。つまり、取得したデータの一部だけが実際には使用されます。

✅ 解決策:

- 🛠️ モデルのコンテキスト長を拡張:
  - **モデルエディタまたはチャットコントロール**に移動
  - コンテキスト長を変更（例:サポートされていれば8192トークン以上に増加）

ℹ️ 注: 2048トークンのデフォルトは大きな制限です。より良いRAGの結果を得るには、長いコンテキストをサポートするモデルを使用することを推奨します。

✅ 別の方法: より大きなコンテキスト容量を持つ外部LLMを使用

- GPT-4、GPT-4o、Claude 3、Gemini 1.5、または8k+コンテキストを持つMixtralを試してみてください。
- Ollamaとの性能を比較—より多くのコンテンツが注入可能になった場合の精度の違いを確認してください！

📌 ヒント: 本番利用ケースでは、外部モデルを使用してRAG性能を向上させることをお勧めします。

---

### 4. 埋め込みモデルの品質が低い、または不適合 📉🧠

埋め込みが悪いと検索も悪くなります。コンテンツのベクトル表現が適切でない場合、リトリーバーは正しいコンテンツを検索できません—LLMがいくら強力であっても同じです。

✅ 解決策:

- 高品質な埋め込みモデルに変更（例: all-MiniLM-L6-v2、Instructor X、またはOpenAI埋め込み）
- **管理設定 > 文書**に移動
- モデル変更後に必ず次を実行：
  - ⏳ 既存文書を再インデックスして、新しい埋め込みが反映されるようにする。

📌 忘れないでください: 埋め込みの品質は取得されるコンテンツに直接影響を与えます。

---

### 5. ❌ 400: NoneType object has no attribute encode

このエラーは、埋め込みモデルが誤って設定されているか、設定が欠落していることを示しています。Open WebUIが埋め込みを作成しようとすると、適切なモデルが読み込まれていない場合、テキストを処理できず、この不可解なエラーが発生します。

💥 原因:
- 埋め込みモデルが適切に設定されていない。
- ダウンロードが完全に終了していない可能性がある。
- 外部埋め込みモデルを使用している場合、アクセス可能でない可能性がある。

✅ 解決策:

- **管理設定 > 文書 > 埋め込みモデル**に移動
- 埋め込みモデルを再保存—既に選択されている場合でも再確認・ダウンロードが強制されます。
- リモート/外部埋め込みツールを使用している場合、Open WebUIにアクセス可能で稼働中であることを確認してください。

📌 ヒント: 設定を修正した後、文書を再埋め込みして、ログにエラーが表示されないことを確認してください。

---

## 🧪 プロのヒント: GPT-4oまたはGPT-4でのテスト

検索、トークン制限、または埋め込みの問題がどこにあるかわからない場合、一時的にGPT-4o（例: OpenAI API経由）を使用してみてください。結果が突然正確になる場合、それはローカルモデルのコンテキスト制限（Ollamaのデフォルトとして2048）がボトルネックであるという強力な証拠になります。

- GPT-4oは大きな入力（128kトークン！）を処理できます。
- システムのRAGの信頼性を評価するための優れたベンチマークを提供します。

---

## 要約チェックリスト ✅

| 問題 | 修正 |
|--------|------|
| 🤔 モデルがコンテンツを「見れない」 | 文書抽出設定を確認する |
| 🧹 コンテンツの一部だけ使用される | フルコンテキストモードを有効にするか埋め込みをバイパスする |
| ⏱ 2048トークン制限により制約 | モデルのコンテキスト長を増やすか、大規模コンテキストLLMを使用する |
| 📉 不正確な検索結果 | より良い埋め込みモデルに切り替えた後、再インデックスする |
| それでも混乱する？ | GPT-4oでテストし、出力を比較する |

---

これらの領域（抽出、埋め込み、検索、モデルコンテキスト）を最適化することで、LLMが文書を正確に扱う能力を大幅に向上させることができます。2048トークンの窓や弱い検索のパイプラインにAIの力を制限させないでください 🎯。
