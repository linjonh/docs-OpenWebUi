---
sidebar_position: 1
title: "üö∞ Fun√ß√£o Pipe"
---

# üö∞ Fun√ß√£o Pipe: Crie "Agentes/Modelos" Personalizados 
Bem-vindo a este guia sobre a cria√ß√£o de **Pipes** no Open WebUI! Pense nos Pipes como uma forma de **adicionar** um novo modelo ao Open WebUI. Neste documento, vamos explicar o que √© um Pipe, como ele funciona e como voc√™ pode criar o seu para adicionar l√≥gica e processamento personalizados aos seus modelos no Open WebUI. Usaremos met√°foras claras e abordaremos todos os detalhes para garantir que voc√™ tenha uma compreens√£o abrangente.


## Introdu√ß√£o aos Pipes

Imagine o Open WebUI como um **sistema de encanamento** onde os dados fluem atrav√©s de tubula√ß√µes e v√°lvulas. Nesta analogia:

- **Pipes** s√£o como **plugins** que permitem introduzir novos caminhos para o fluxo de dados, possibilitando a inje√ß√£o de l√≥gica e processamento personalizados.
- **V√°lvulas** s√£o as **partes configur√°veis** do seu pipe que controlam como os dados fluem atrav√©s dele.

Ao criar um Pipe, voc√™ est√° essencialmente elaborando um modelo personalizado com o comportamento espec√≠fico que deseja, tudo dentro do framework do Open WebUI.

---

## Entendendo a Estrutura do Pipe

Vamos come√ßar com uma vers√£o b√°sica e simples de um Pipe para entender sua estrutura:

```python
from pydantic import BaseModel, Field

class Pipe:
    class Valves(BaseModel):
        MODEL_ID: str = Field(default="")

    def __init__(self):
        self.valves = self.Valves()

    def pipe(self, body: dict):
        # L√≥gica vai aqui
        print(self.valves, body)  # Isso vai imprimir as op√ß√µes de configura√ß√£o e o corpo de entrada
        return "Ol√°, Mundo!"
```

### A Classe Pipe

- **Defini√ß√£o**: A classe `Pipe` √© onde voc√™ define sua l√≥gica personalizada.
- **Prop√≥sito**: Atua como o plano para seu plugin, determinando como ele se comporta dentro do Open WebUI.

### V√°lvulas: Configurando Seu Pipe

- **Defini√ß√£o**: `Valves` √© uma classe aninhada dentro do `Pipe`, herdando de `BaseModel`.
- **Prop√≥sito**: Cont√©m as op√ß√µes de configura√ß√£o (par√¢metros) que persistem durante o uso do seu Pipe.
- **Exemplo**: No c√≥digo acima, `MODEL_ID` √© uma op√ß√£o de configura√ß√£o com uma string vazia por padr√£o.

**Met√°fora**: Pense nas v√°lvulas como os bot√µes em um sistema de tubula√ß√£o do mundo real que controlam o fluxo de √°gua. No seu Pipe, as v√°lvulas permitem que os usu√°rios ajustem configura√ß√µes que influenciam como os dados fluem e s√£o processados.

### O M√©todo `__init__`

- **Defini√ß√£o**: O m√©todo construtor da classe `Pipe`.
- **Prop√≥sito**: Inicializa o estado do Pipe e configura quaisquer componentes necess√°rios.
- **Melhor Pr√°tica**: Mantenha simples; apenas inicialize o `self.valves` aqui.

```python
def __init__(self):
    self.valves = self.Valves()
```

### A Fun√ß√£o `pipe`

- **Defini√ß√£o**: A fun√ß√£o principal onde reside sua l√≥gica personalizada.
- **Par√¢metros**:
  - `body`: Um dicion√°rio contendo os dados de entrada.
- **Prop√≥sito**: Processa os dados de entrada usando sua l√≥gica personalizada e retorna o resultado.

```python
def pipe(self, body: dict):
    # L√≥gica vai aqui
    print(self.valves, body)  # Isso vai imprimir as op√ß√µes de configura√ß√£o e o corpo de entrada
    return "Ol√°, Mundo!"
```

**Nota**: Sempre coloque `Valves` no topo da sua classe `Pipe`, seguido por `__init__`, e depois pela fun√ß√£o `pipe`. Essa estrutura garante clareza e consist√™ncia.

---

## Criando M√∫ltiplos Modelos com Pipes

E se voc√™ quiser que seu Pipe crie **m√∫ltiplos modelos** dentro do Open WebUI? Voc√™ pode fazer isso definindo uma fun√ß√£o ou vari√°vel `pipes` dentro da sua classe `Pipe`. Essa configura√ß√£o, informalmente chamada de **manifold**, permite que seu Pipe represente v√°rios modelos.

Veja como fazer isso:

```python
from pydantic import BaseModel, Field

class Pipe:
    class Valves(BaseModel):
        MODEL_ID: str = Field(default="")

    def __init__(self):
        self.valves = self.Valves()

    def pipes(self):
        return [
            {"id": "model_id_1", "name": "model_1"},
            {"id": "model_id_2", "name": "model_2"},
            {"id": "model_id_3", "name": "model_3"},
        ]

    def pipe(self, body: dict):
        # L√≥gica vai aqui
        print(self.valves, body)  # Imprime as op√ß√µes de configura√ß√£o e o corpo de entrada
        model = body.get("model", "")
        return f"{model}: Ol√°, Mundo!"
```

### Explica√ß√£o

- **Fun√ß√£o `pipes`**:
  - Retorna uma lista de dicion√°rios.
  - Cada dicion√°rio representa um modelo com chaves √∫nicas `id` e `name`.
  - Esses modelos aparecer√£o individualmente no seletor de modelos do Open WebUI.

- **Fun√ß√£o `pipe` Atualizada**:
  - Processa entrada com base no modelo selecionado.
  - Neste exemplo, inclui o nome do modelo na string retornada.

---

## Exemplo: Pipe Proxy OpenAI

Vamos explorar um exemplo pr√°tico onde criaremos um Pipe que faz proxy de solicita√ß√µes para a API do OpenAI. Este Pipe buscar√° modelos dispon√≠veis do OpenAI e permitir√° que os usu√°rios interajam com eles atrav√©s do Open WebUI.

```python
from pydantic import BaseModel, Field
import requests

class Pipe:
    class Valves(BaseModel):
        NAME_PREFIX: str = Field(
            default="OPENAI/",
            description="Prefixo a ser adicionado antes dos nomes dos modelos.",
        )
        OPENAI_API_BASE_URL: str = Field(
            default="https://api.openai.com/v1",
            description="URL base para acessar os endpoints da API do OpenAI.",
        )
        OPENAI_API_KEY: str = Field(
            default="",
            description="Chave de API para autenticar solicita√ß√µes √† API do OpenAI.",
        )

    def __init__(self):
        self.valves = self.Valves()

    def pipes(self):
        if self.valves.OPENAI_API_KEY:
            try:
                headers = {
                    "Authorization": f"Bearer {self.valves.OPENAI_API_KEY}",
                    "Content-Type": "application/json",
                }

                r = requests.get(
                    f"{self.valves.OPENAI_API_BASE_URL}/models", headers=headers
                )
                models = r.json()
                return [
                    {
                        "id": model["id"],
                        "name": f{self.valves.NAME_PREFIX}{model.get("name", model["id"])},
                    }
                    for model in models["data"]
                    if "gpt" in model["id"]
                ]

            except Exception as e:
                return [
                    {
                        "id": "error",
                        "name": "Erro ao buscar modelos. Verifique sua Chave de API.",
                    },
                ]
        else:
            return [
                {
                    "id": "error",
                    "name": "Chave de API n√£o fornecida.",
                },
            ]

    def pipe(self, body: dict, __user__: dict):
        print(f"pipe:{__name__}")
        headers = {
            "Authorization": f"Bearer {self.valves.OPENAI_API_KEY}",
            "Content-Type": "application/json",
        }

        # Extrair id do modelo a partir do nome do modelo
        model_id = body["model"][body["model"].find(".") + 1 :]

        # Atualizar o id do modelo no body
        payload = {**body, "model": model_id}
        try:
            r = requests.post(
                url=f"{self.valves.OPENAI_API_BASE_URL}/chat/completions",
                json=payload,
                headers=headers,
                stream=True,
            )

            r.raise_for_status()

            if body.get("stream", False):
                return r.iter_lines()
            else:
                return r.json()
        except Exception as e:
            return f"Erro: {e}"
```

### Descri√ß√£o Detalhada

#### Configura√ß√£o de Valves

- **`NAME_PREFIX`**:
  - Adiciona um prefixo aos nomes dos modelos exibidos no Open WebUI.
  - Padr√£o: `"OPENAI/"`.
- **`OPENAI_API_BASE_URL`**:
  - Especifica a URL base para a API do OpenAI.
  - Padr√£o: `"https://api.openai.com/v1"`.
- **`OPENAI_API_KEY`**:
  - Sua chave de API do OpenAI para autentica√ß√£o.
  - Padr√£o: `""` (string vazia; deve ser fornecida).

#### A Fun√ß√£o `pipes`

- **Prop√≥sito**: Busca os modelos dispon√≠veis do OpenAI e os torna acess√≠veis no Open WebUI.

- **Processo**:
  1. **Verificar a Chave de API**: Garante que uma chave de API foi fornecida.
  2. **Buscar Modelos**: Faz uma solicita√ß√£o GET para a API do OpenAI para recuperar os modelos dispon√≠veis.
  3. **Filtrar Modelos**: Retorna modelos que possuem `"gpt"` no seu `id`.
  4. **Tratamento de Erros**: Em caso de problema, retorna uma mensagem de erro.

- **Formato de Retorno**: Uma lista de dicion√°rios com `id` e `name` para cada modelo.

#### A Fun√ß√£o `pipe`

- **Prop√≥sito**: Gerencia a solicita√ß√£o ao modelo OpenAI selecionado e retorna a resposta.

- **Par√¢metros**:
  - `body`: Cont√©m os dados da solicita√ß√£o.
  - `__user__`: Cont√©m informa√ß√µes do usu√°rio (n√£o usado neste exemplo, mas pode ser √∫til para autentica√ß√£o ou registro de log).

- **Processo**:
  1. **Preparar Cabe√ßalhos**: Configura os cabe√ßalhos com a chave de API e o tipo de conte√∫do.
  2. **Extrair ID do Modelo**: Extrai o ID real do modelo a partir do nome do modelo selecionado.
  3. **Preparar Payload**: Atualiza o body com o ID correto do modelo.
  4. **Fazer a Solicita√ß√£o para API**: Envia uma solicita√ß√£o POST para o endpoint de completions da API do OpenAI.
  5. **Gerenciar Streaming**: Se `stream` for `True`, retorna um iter√°vel de linhas.
  6. **Tratamento de Erros**: Captura exce√ß√µes e retorna uma mensagem de erro.

### Estendendo o Proxy Pipe

Voc√™ pode modificar este Proxy Pipe para oferecer suporte a provedores de servi√ßo adicionais como Anthropic, Perplexity e outros, ajustando os endpoints da API, cabe√ßalhos e l√≥gica dentro das fun√ß√µes `pipes` e `pipe`.

---

## Usando Fun√ß√µes Internas do Open WebUI

√Äs vezes, pode ser √∫til aproveitar as fun√ß√µes internas do Open WebUI dentro do seu Pipe. Voc√™ pode importar essas fun√ß√µes diretamente do pacote `open_webui`. Tenha em mente que, embora improv√°vel, fun√ß√µes internas podem mudar devido a otimiza√ß√µes, ent√£o sempre consulte a documenta√ß√£o mais recente.

Veja como usar fun√ß√µes internas do Open WebUI:

```python
from pydantic import BaseModel, Field
from fastapi import Request

from open_webui.models.users import Users
de open_webui.utils.chat import gerar_completamento_de_chat

classe Pipe:
    def __init__(self):
        passar

    async def pipe(
        self,
        body: dict,
        __user__: dict,
        __request__: Request,
    ) -> str:
        # Use o endpoint unificado com a assinatura atualizada
        user = Users.get_user_by_id(__user__["id"])
        body["model"] = "llama3.2:latest"
        return await generate_chat_completion(__request__, body, user)
```

### Explica√ß√£o

- **Importa√ß√µes**:
  - `Users` de `open_webui.models.users`: Para buscar informa√ß√µes do usu√°rio.
  - `generate_chat_completion` de `open_webui.utils.chat`: Para gerar conclus√µes de chat utilizando l√≥gica interna.

- **Fun√ß√£o ass√≠ncrona `pipe`**:
  - **Par√¢metros**:
    - `body`: Dados de entrada para o modelo.
    - `__user__`: Dicion√°rio contendo informa√ß√µes do usu√°rio.
    - `__request__`: Objeto de solicita√ß√£o do FastAPI (necess√°rio para `generate_chat_completion`).
  - **Processo**:
    1. **Buscar Objeto Usu√°rio**: Recupera o objeto do usu√°rio usando seu ID.
    2. **Definir Modelo**: Especifica o modelo a ser usado.
    3. **Gerar Completa√ß√£o**: Chama `generate_chat_completion` para processar a entrada e produzir uma sa√≠da.

### Notas Importantes

- **Assinaturas de Fun√ß√£o**: Consulte a base de c√≥digo ou documenta√ß√£o mais recente do Open WebUI para assinaturas e par√¢metros de fun√ß√£o atualizados.
- **Boas Pr√°ticas**: Sempre trate exce√ß√µes e erros de maneira elegante para assegurar uma experi√™ncia tranquila ao usu√°rio.

---

## Perguntas Frequentes

### Q1: Por que devo usar Pipes no Open WebUI?

**A**: Pipes permitem adicionar novos "model" com l√≥gica personalizada e processamento ao Open WebUI. √â um sistema de plug-in flex√≠vel que permite integrar APIs externas, personalizar comportamentos de modelo e criar recursos inovadores sem alterar a base de c√≥digo central.

---

### Q2: O que s√£o Valves e por que s√£o importantes?

**A**: Valves s√£o os par√¢metros configur√°veis do seu Pipe. Funcionam como defini√ß√µes ou controles que determinam como seu Pipe opera. Ajustando Valves, voc√™ pode alterar o comportamento do seu Pipe sem modificar o c√≥digo subjacente.

---

### Q3: Posso criar um Pipe sem Valves?

**A**: Sim, voc√™ pode criar um Pipe simples sem definir uma classe Valves se seu Pipe n√£o precisar de op√ß√µes de configura√ß√£o persistentes. No entanto, incluir Valves √© uma boa pr√°tica para flexibilidade e escalabilidade futura.

---

### Q4: Como garanto que meu Pipe seja seguro ao usar chaves de API?

**A**: Nunca insira informa√ß√µes sens√≠veis como chaves de API diretamente no seu Pipe. Em vez disso, use Valves para inserir e armazenar chaves de API de forma segura. Certifique-se de que seu c√≥digo trate essas chaves de forma adequada e evite registr√°-las ou exp√¥-las.

---

### Q5: Qual √© a diferen√ßa entre as fun√ß√µes `pipe` e `pipes`?

**A**:

- **Fun√ß√£o `pipe`**: A fun√ß√£o principal onde voc√™ processa os dados de entrada e gera uma sa√≠da. Ela gerencia a l√≥gica para um √∫nico modelo.

- **Fun√ß√£o `pipes`**: Permite que seu Pipe represente v√°rios modelos retornando uma lista de defini√ß√µes de modelo. Cada modelo aparecer√° individualmente no Open WebUI.

---

### Q6: Como posso tratar erros no meu Pipe?

**A**: Use blocos try-except dentro das suas fun√ß√µes `pipe` e `pipes` para capturar exce√ß√µes. Retorne mensagens de erro significativas ou trate os erros de maneira elegante para assegurar que o usu√°rio seja informado sobre o que deu errado.

---

### Q7: Posso usar bibliotecas externas no meu Pipe?

**A**: Sim, voc√™ pode importar e usar bibliotecas externas conforme necess√°rio. Certifique-se de que todas as depend√™ncias sejam instaladas e gerenciadas corretamente dentro do seu ambiente.

---

### Q8: Como posso testar meu Pipe?

**A**: Teste seu Pipe executando o Open WebUI em um ambiente de desenvolvimento e selecionando seu modelo personalizado na interface. Valide se seu Pipe se comporta como esperado com v√°rias entradas e configura√ß√µes.

---

### Q9: Existem boas pr√°ticas para organizar o c√≥digo do meu Pipe?

**A**: Sim, siga estas diretrizes:

- Mantenha `Valves` no topo da sua classe `Pipe`.
- Inicialize vari√°veis no m√©todo `__init__`, principalmente `self.valves`.
- Coloque a fun√ß√£o `pipe` depois do m√©todo `__init__`.
- Use nomes de vari√°veis claros e descritivos.
- Comente seu c√≥digo por clareza.

---

### Q10: Onde posso encontrar a documenta√ß√£o mais recente do Open WebUI?

**A**: Visite o reposit√≥rio oficial ou site de documenta√ß√£o do Open WebUI para obter as informa√ß√µes mais atualizadas, incluindo assinaturas de fun√ß√£o, exemplos e guias de migra√ß√£o caso ocorram altera√ß√µes.

---

## Conclus√£o

Agora voc√™ deve ter uma compreens√£o completa de como criar e usar Pipes no Open WebUI. Pipes oferecem uma maneira poderosa de estender e personalizar as capacidades do Open WebUI para atender suas necessidades espec√≠ficas. Seja integrando APIs externas, adicionando novos modelos ou injetando l√≥gica complexa, Pipes fornecem a flexibilidade para que isso aconte√ßa.

Lembre-se de:

- **Usar uma estrutura clara e consistente** nas suas classes de Pipe.
- **Aproveitar Valves** para op√ß√µes configur√°veis.
- **Tratar erros de maneira elegante** para melhorar a experi√™ncia do usu√°rio.
- **Consulte a documenta√ß√£o mais recente** para atualiza√ß√µes ou altera√ß√µes.

Boa codifica√ß√£o e aproveite para estender seu Open WebUI com Pipes!
